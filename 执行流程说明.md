# Q5Tab æŒ‰é’®ç‚¹å‡»æ‰§è¡Œæµç¨‹è¯´æ˜

## æ¦‚è¿°
å½“ç”¨æˆ·ç‚¹å‡»"åŠ è½½èŒä½æ’åæ•°æ®"æŒ‰é’®æ—¶ï¼Œä»å‰ç«¯åˆ°åç«¯çš„å®Œæ•´æ‰§è¡Œæµç¨‹ã€‚

---

## æ‰§è¡Œé¡ºåº

### 1ï¸âƒ£ **å‰ç«¯ï¼šç”¨æˆ·äº¤äº’å±‚**
**æ–‡ä»¶**: `fronted/src/components/tabs/Q5Tab.vue`

```vue
<button class="btn" @click="handleLoadChart" :disabled="loading">
  {{ loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½èŒä½æ’åæ•°æ®' }}
</button>
```

**æ‰§è¡Œæ­¥éª¤**:
- ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
- è§¦å‘ `@click="handleLoadChart"` äº‹ä»¶
- æŒ‰é’®è¿›å…¥ç¦ç”¨çŠ¶æ€ï¼ˆ`:disabled="loading"`ï¼‰

---

### 2ï¸âƒ£ **å‰ç«¯ï¼šäº‹ä»¶å¤„ç†å‡½æ•°**
**æ–‡ä»¶**: `fronted/src/components/tabs/Q5Tab.vue` (ç¬¬44-50è¡Œ)

```javascript
const handleLoadChart = async () => {
  try {
    await execute()  // è°ƒç”¨ useFetchData è¿”å›çš„ execute å‡½æ•°
  } catch (err) {
    console.error('åŠ è½½èŒä½æ’åæ•°æ®å¤±è´¥:', err)
  }
}
```

**æ‰§è¡Œæ­¥éª¤**:
- è°ƒç”¨ `execute()` å‡½æ•°ï¼ˆæ¥è‡ª `useFetchData` hookï¼‰
- ä½¿ç”¨ `async/await` å¤„ç†å¼‚æ­¥æ“ä½œ
- æ•è·å¹¶æ‰“å°é”™è¯¯ä¿¡æ¯

---

### 3ï¸âƒ£ **å‰ç«¯ï¼šæ•°æ®è·å– Hook**
**æ–‡ä»¶**: `fronted/src/utils/fetchData.js` (ç¬¬11-46è¡Œ)

```javascript
export function useFetchData(apiFunction) {
  const data = ref(null)
  const loading = ref(false)
  const error = ref(null)

  const execute = async (...args) => {
    loading.value = true      // 1. è®¾ç½®åŠ è½½çŠ¶æ€
    error.value = null        // 2. æ¸…ç©ºé”™è¯¯ä¿¡æ¯
    
    try {
      const response = await apiFunction(...args)  // 3. è°ƒç”¨APIå‡½æ•°
      data.value = response   // 4. ä¿å­˜å“åº”æ•°æ®
      return response
    } catch (err) {
      error.value = errorMessage  // 5. è®¾ç½®é”™è¯¯ä¿¡æ¯
      throw err
    } finally {
      loading.value = false    // 6. å…³é—­åŠ è½½çŠ¶æ€
    }
  }
}
```

**æ‰§è¡Œæ­¥éª¤**:
1. è®¾ç½® `loading.value = true` â†’ æŒ‰é’®æ˜¾ç¤º"åŠ è½½ä¸­..."
2. æ¸…ç©º `error.value = null`
3. è°ƒç”¨ä¼ å…¥çš„ `apiFunction`ï¼ˆå³ `getJobRanking`ï¼‰
4. ç­‰å¾…APIå“åº”
5. å°†å“åº”æ•°æ®ä¿å­˜åˆ° `data.value`
6. æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œæœ€ç»ˆè®¾ç½® `loading.value = false`

---

### 4ï¸âƒ£ **å‰ç«¯ï¼šAPI è°ƒç”¨å‡½æ•°**
**æ–‡ä»¶**: `fronted/src/api/industryApi.js` (ç¬¬39-41è¡Œ)

```javascript
export async function getJobRanking() {
  return await apiClient.get('/industry/ranking/jobs')
}
```

**æ‰§è¡Œæ­¥éª¤**:
- è°ƒç”¨ `apiClient.get()` æ–¹æ³•
- è¯·æ±‚è·¯å¾„: `/industry/ranking/jobs`
- è¿”å› Promise

---

### 5ï¸âƒ£ **å‰ç«¯ï¼šHTTP å®¢æˆ·ç«¯é…ç½®**
**æ–‡ä»¶**: `fronted/src/api/apiClient.js`

**æ‰§è¡Œæ­¥éª¤**:

#### 5.1 åˆ›å»ºè¯·æ±‚é…ç½®
```javascript
const apiClient = axios.create({
  baseURL: appConfig.api.baseURL,  // '/api' (æ¥è‡ª appConfig.js)
  timeout: 50000,
  headers: { 'Content-Type': 'application/json' }
})
```

#### 5.2 è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆç¬¬17-25è¡Œï¼‰
```javascript
apiClient.interceptors.request.use((config) => {
  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ tokenç­‰
  return config
})
```
- å¤„ç†è¯·æ±‚é…ç½®ï¼ˆå½“å‰ä¸ºç©ºå®ç°ï¼‰

#### 5.3 å‘é€ HTTP è¯·æ±‚
- **å®é™…è¯·æ±‚URL**: `http://localhost:5001/api/industry/ranking/jobs`
  - åŸºç¡€URL: `/api` (é€šè¿‡ Vite ä»£ç†è½¬å‘åˆ° `http://localhost:5001`)
  - å®Œæ•´è·¯å¾„: `/api/industry/ranking/jobs`

#### 5.4 å“åº”æ‹¦æˆªå™¨ï¼ˆç¬¬28-78è¡Œï¼‰
```javascript
apiClient.interceptors.response.use(
  (response) => {
    return response.data  // ç›´æ¥è¿”å› response.dataï¼Œè€Œä¸æ˜¯æ•´ä¸ª response å¯¹è±¡
  },
  (error) => {
    // é”™è¯¯å¤„ç†é€»è¾‘
    return Promise.reject(enhancedError)
  }
)
```

**æ‰§è¡Œæ­¥éª¤**:
- æˆåŠŸæ—¶ï¼šè¿”å› `response.data`ï¼ˆå‰¥ç¦» axios å“åº”åŒ…è£…ï¼‰
- å¤±è´¥æ—¶ï¼šåˆ›å»ºå¢å¼ºçš„é”™è¯¯å¯¹è±¡å¹¶ reject

---

### 6ï¸âƒ£ **ç½‘ç»œå±‚ï¼šVite å¼€å‘æœåŠ¡å™¨ä»£ç†**
**æ–‡ä»¶**: `fronted/vite.config.js` (ç¬¬16-36è¡Œ)

```javascript
server: {
  port: 3000,
  proxy: {
    '/api': {
      target: 'http://localhost:5001',  // ä»£ç†åˆ°åç«¯æœåŠ¡å™¨
      changeOrigin: true,
      secure: false,
      ws: true,
      timeout: 30000
    }
  }
}
```

**æ‰§è¡Œæ­¥éª¤**:
- å‰ç«¯è¯·æ±‚ `/api/industry/ranking/jobs`
- Vite ä»£ç†æ‹¦æˆª `/api` å¼€å¤´çš„è¯·æ±‚
- è½¬å‘åˆ° `http://localhost:5001/api/industry/ranking/jobs`
- ç­‰å¾…åç«¯å“åº”å¹¶è¿”å›ç»™å‰ç«¯

---

### 7ï¸âƒ£ **åç«¯ï¼šFlask è·¯ç”±å¤„ç†**
**æ–‡ä»¶**: `routes/industry_routes.py` (ç¬¬269-295è¡Œ)

```python
@industry_bp.route('/industry/ranking/jobs', methods=['GET'])
def get_job_ranking():
    """è·å–èŒä½ç»¼åˆæ’åæŸ±çŠ¶å›¾æ•°æ®"""
    try:
        # è·å–èŒä½æ’åæ•°æ®ï¼ˆé»˜è®¤è¿”å›å‰5åï¼‰
        job_rankings = trend_service.get_job_ranking(top_n=5)
        
        # è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
        jobs_data = [
            {
                "job_title": job.job_title,
                "records_count_norm": job.records_count_norm,
                "education_rank": job.education_rank,
                "experience_rank": job.experience_rank,
                "composite_score": job.composite_score
            }
            for job in job_rankings
        ]
        
        return ResponseBuilder.success("è·å–èŒä½ç»¼åˆæ’åæ•°æ®æˆåŠŸ", {"jobs": jobs_data})
    except FileNotFoundError as e:
        return ResponseBuilder.not_found(f"æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨: {str(e)}")
    except Exception as e:
        return ResponseBuilder.internal_error("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", {...})
```

**æ‰§è¡Œæ­¥éª¤**:
1. Flask è·¯ç”±åŒ¹é… `/api/industry/ranking/jobs`
2. è°ƒç”¨ `trend_service.get_job_ranking(top_n=5)`
3. å°†è¿”å›çš„ `JobRanking` å¯¹è±¡åˆ—è¡¨è½¬æ¢ä¸ºå­—å…¸
4. ä½¿ç”¨ `ResponseBuilder.success()` æ„å»ºå“åº”
5. è¿”å› JSON å“åº”

---

### 8ï¸âƒ£ **åç«¯ï¼šä¸šåŠ¡é€»è¾‘æœåŠ¡**
**æ–‡ä»¶**: `services/trend_service.py` (ç¬¬66-132è¡Œ)

```python
def get_job_ranking(self, top_n: int = 5) -> List[JobRanking]:
    """è·å–èŒä½ç»¼åˆæ’åæ•°æ®"""
    try:
        # 1. è¯»å–Excelæ–‡ä»¶
        df = pd.read_excel(self.job_summary_path, engine='openpyxl')
        
        # 2. å»é‡
        df_unique = df.drop_duplicates(subset=['job_title'], keep='first')
        
        # 3. è®¡ç®—å½’ä¸€åŒ–å€¼
        df_unique['education_norm'] = df_unique['avg_education_rank'] / 10.0
        df_unique['experience_norm'] = df_unique['avg_experience_rank'] / 10.0
        
        # 4. è®¡ç®—ç»¼åˆå¾—åˆ†
        df_unique['composite_score'] = (
            df_unique['education_norm'] * 
            df_unique['records_count_norm'] * 
            df_unique['experience_norm']
        )
        
        # 5. æ’åºå¹¶å–å‰Nå
        df_sorted = df_unique.nlargest(top_n, 'composite_score')
        
        # 6. æ„å»ºè¿”å›æ•°æ®
        job_rankings = []
        for _, row in df_sorted.iterrows():
            job_ranking = JobRanking(...)
            job_rankings.append(job_ranking)
        
        return job_rankings
```

**æ‰§è¡Œæ­¥éª¤**:
1. **è¯»å–æ•°æ®æ–‡ä»¶**: `dataset/dataset/job_summary.xlsx`
2. **æ•°æ®å»é‡**: æŒ‰ `job_title` å»é‡ï¼Œä¿ç•™ç¬¬ä¸€æ¡
3. **å½’ä¸€åŒ–è®¡ç®—**:
   - `education_norm = avg_education_rank / 10.0`
   - `experience_norm = avg_experience_rank / 10.0`
4. **ç»¼åˆå¾—åˆ†è®¡ç®—**: `composite_score = education_norm Ã— records_count_norm Ã— experience_norm`
5. **æ’åºç­›é€‰**: æŒ‰ `composite_score` é™åºï¼Œå–å‰5å
6. **æ„å»ºå¯¹è±¡**: åˆ›å»º `JobRanking` å¯¹è±¡åˆ—è¡¨
7. **è¿”å›æ•°æ®**: è¿”å› `List[JobRanking]`

---

### 9ï¸âƒ£ **åç«¯ï¼šå“åº”æ„å»º**
**æ–‡ä»¶**: `utils/response.py` (ç¬¬17-30è¡Œ)

```python
@staticmethod
def success(message: str, data: Any = None, code: int = 200) -> tuple:
    response = {
        "status": "success",
        "code": 200,
        "message": message,
        "timestamp": datetime.now().isoformat(),
        "request_id": str(uuid.uuid4())
    }
    
    if data is not None:
        response["data"] = data
    
    return jsonify(response), code
```

**å“åº”æ ¼å¼**:
```json
{
  "status": "success",
  "code": 200,
  "message": "è·å–èŒä½ç»¼åˆæ’åæ•°æ®æˆåŠŸ",
  "timestamp": "2025-01-XXT10:30:00",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "data": {
    "jobs": [
      {
        "job_title": "èŒä½åç§°",
        "records_count_norm": 0.782,
        "education_rank": 0.666,
        "experience_rank": 0.506,
        "composite_score": 0.264
      },
      ...
    ]
  }
}
```

---

### ğŸ”Ÿ **å‰ç«¯ï¼šæ¥æ”¶å“åº”å¹¶æ›´æ–°çŠ¶æ€**
**æ–‡ä»¶**: `fronted/src/utils/fetchData.js` (ç¬¬20-23è¡Œ)

```javascript
const response = await apiFunction(...args)  // ç­‰å¾…åç«¯å“åº”
data.value = response  // ä¿å­˜åˆ°å“åº”å¼æ•°æ®
return response
```

**æ‰§è¡Œæ­¥éª¤**:
- `apiFunction` (å³ `getJobRanking`) è¿”å›å“åº”æ•°æ®
- å°†æ•°æ®ä¿å­˜åˆ° `data.value`
- è§¦å‘ Vue å“åº”å¼æ›´æ–°

---

### 1ï¸âƒ£1ï¸âƒ£ **å‰ç«¯ï¼šç»„ä»¶å“åº”å¼æ›´æ–°**
**æ–‡ä»¶**: `fronted/src/components/tabs/Q5Tab.vue` (ç¬¬21-26è¡Œ)

```vue
<MultiIconBarChart 
  v-if="chartData?.data?.jobs"
  :data="chartData.data.jobs"
  :loading="loading"
  :error="error"
/>
```

**æ‰§è¡Œæ­¥éª¤**:
1. `chartData` æ›´æ–°ï¼ˆæ¥è‡ª `useFetchData` çš„ `data`ï¼‰
2. `v-if="chartData?.data?.jobs"` æ¡ä»¶æ»¡è¶³
3. `MultiIconBarChart` ç»„ä»¶æ˜¾ç¤º
4. ä¼ é€’ `data` prop: `chartData.data.jobs`ï¼ˆèŒä½æ•°ç»„ï¼‰

---

### 1ï¸âƒ£2ï¸âƒ£ **å‰ç«¯ï¼šå›¾è¡¨ç»„ä»¶æ¸²æŸ“**
**æ–‡ä»¶**: `fronted/src/components/charts/MultiIconBarChart.vue`

**æ‰§è¡Œæ­¥éª¤**:

#### 12.1 ç›‘å¬æ•°æ®å˜åŒ–
```javascript
watch(() => props.data, (newData) => {
  if (newData && newData.length > 0) {
    nextTick(() => {
      renderChart()  // æ¸²æŸ“å›¾è¡¨
    })
  }
}, { immediate: true, deep: true })
```

#### 12.2 æ¸²æŸ“å›¾è¡¨
```javascript
const renderChart = () => {
  // 1. æ¸…é™¤æ—§å›¾è¡¨
  d3.select(container).selectAll('*').remove()
  
  // 2. åˆ›å»ºSVGå’Œæ¯”ä¾‹å°º
  svg = d3.select(container).append('svg')
  xScale = d3.scaleLinear().domain([0, 10]).range([0, chartWidth])
  yScale = d3.scaleBand().domain(data.map(d => d.job_title)).range([0, chartHeight])
  
  // 3. ä¸ºæ¯ä¸ªèŒä½åˆ›å»ºæŸ±çŠ¶å›¾
  data.forEach((job, index) => {
    // åˆ›å»ºä¸‰ä¸ªå›¾æ ‡ç»„ï¼ˆæ‹›è˜æ•°é‡ã€å­¦å†ã€ç»éªŒï¼‰
    const gridCount1 = valueToGridCount(job.records_count_norm)
    const gridCount2 = valueToGridCount(job.education_rank)
    const gridCount3 = valueToGridCount(job.experience_rank)
    
    // æ¸²æŸ“å›¾æ ‡
    renderIconGroup('person', gridCount1, ...)
    renderIconGroup('education', gridCount2, ...)
    renderIconGroup('experience', gridCount3, ...)
  })
  
  // 4. æ·»åŠ åæ ‡è½´å’Œæ ‡ç­¾
  // 5. æ·»åŠ æ‚¬åœæç¤º
}
```

#### 12.3 å›¾è¡¨å±•ç¤º
- æ¯ä¸ªèŒä½æ˜¾ç¤ºä¸ºä¸€è¡Œ
- æ¯è¡ŒåŒ…å«ä¸‰ä¸ªå›¾æ ‡ç»„ï¼ˆæ‹›è˜æ•°é‡ã€å­¦å†ã€ç»éªŒï¼‰
- æ¯ä¸ªå›¾æ ‡ç»„ç”¨æ ¼å­æ•°é‡è¡¨ç¤ºå½’ä¸€åŒ–å€¼ï¼ˆ0-10ä¸ªæ ¼å­ï¼‰
- æ”¯æŒé¼ æ ‡æ‚¬åœæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

---

## å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
    â†“
handleLoadChart() æ‰§è¡Œ
    â†“
execute() (useFetchData)
    â†“
loading = true (æŒ‰é’®ç¦ç”¨)
    â†“
getJobRanking() (APIå‡½æ•°)
    â†“
apiClient.get('/industry/ranking/jobs')
    â†“
è¯·æ±‚æ‹¦æˆªå™¨å¤„ç†
    â†“
HTTPè¯·æ±‚: GET /api/industry/ranking/jobs
    â†“
Viteä»£ç†è½¬å‘åˆ° http://localhost:5001
    â†“
Flaskè·¯ç”±: /api/industry/ranking/jobs
    â†“
trend_service.get_job_ranking(top_n=5)
    â†“
è¯»å–Excelæ–‡ä»¶: dataset/dataset/job_summary.xlsx
    â†“
æ•°æ®å¤„ç†: å»é‡ã€å½’ä¸€åŒ–ã€è®¡ç®—ç»¼åˆå¾—åˆ†ã€æ’åº
    â†“
è¿”å› JobRanking å¯¹è±¡åˆ—è¡¨
    â†“
è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
    â†“
ResponseBuilder.success() æ„å»ºå“åº”
    â†“
è¿”å›JSONå“åº”
    â†“
å“åº”æ‹¦æˆªå™¨å¤„ç† (è¿”å› response.data)
    â†“
execute() æ¥æ”¶å“åº”
    â†“
data.value = response (æ›´æ–°å“åº”å¼æ•°æ®)
    â†“
loading = false (æŒ‰é’®æ¢å¤)
    â†“
Q5Tab ç»„ä»¶æ£€æµ‹åˆ° chartData æ›´æ–°
    â†“
MultiIconBarChart ç»„ä»¶æ¥æ”¶ data prop
    â†“
watch ç›‘å¬å™¨è§¦å‘
    â†“
renderChart() æ¸²æŸ“D3å›¾è¡¨
    â†“
å›¾è¡¨æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
```

---

## å…³é”®æ—¶é—´ç‚¹

1. **T0**: ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
2. **T1**: `loading = true`ï¼ŒæŒ‰é’®æ˜¾ç¤º"åŠ è½½ä¸­..."
3. **T2**: HTTPè¯·æ±‚å‘é€
4. **T3**: åç«¯å¼€å§‹å¤„ç†ï¼ˆè¯»å–Excelã€è®¡ç®—ï¼‰
5. **T4**: åç«¯è¿”å›å“åº”
6. **T5**: å‰ç«¯æ¥æ”¶å“åº”ï¼Œ`data.value` æ›´æ–°
7. **T6**: `loading = false`ï¼ŒæŒ‰é’®æ¢å¤
8. **T7**: å›¾è¡¨ç»„ä»¶æ£€æµ‹åˆ°æ•°æ®å˜åŒ–
9. **T8**: D3å›¾è¡¨æ¸²æŸ“å®Œæˆ

---

## é”™è¯¯å¤„ç†æµç¨‹

å¦‚æœä»»ä½•æ­¥éª¤å‡ºé”™ï¼š

1. **å‰ç«¯APIè°ƒç”¨å¤±è´¥**:
   - `catch` å—æ•è·é”™è¯¯
   - `error.value` è®¾ç½®ä¸ºé”™è¯¯ä¿¡æ¯
   - æ˜¾ç¤ºé”™è¯¯æç¤º

2. **åç«¯å¤„ç†å¤±è´¥**:
   - Flask æ•è·å¼‚å¸¸
   - è¿”å›é”™è¯¯å“åº”ï¼ˆ400/404/500ï¼‰
   - å‰ç«¯å“åº”æ‹¦æˆªå™¨å¤„ç†é”™è¯¯
   - `error.value` æ›´æ–°ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

3. **æ–‡ä»¶ä¸å­˜åœ¨**:
   - `FileNotFoundError` å¼‚å¸¸
   - è¿”å› 404 å“åº”
   - å‰ç«¯æ˜¾ç¤º"æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"

---

## æ•°æ®æµè½¬

```
Excelæ–‡ä»¶ (job_summary.xlsx)
    â†“
pandas DataFrame
    â†“
JobRanking å¯¹è±¡åˆ—è¡¨
    â†“
Python å­—å…¸åˆ—è¡¨
    â†“
JSON å“åº”
    â†“
JavaScript å¯¹è±¡
    â†“
Vue å“åº”å¼æ•°æ® (ref)
    â†“
ç»„ä»¶ Props
    â†“
D3.js æ•°æ®ç»‘å®š
    â†“
SVG DOM å…ƒç´ 
    â†“
æµè§ˆå™¨æ¸²æŸ“
```

---

## æ€»ç»“

æ•´ä¸ªæµç¨‹æ¶‰åŠï¼š
- **å‰ç«¯**: Vue 3 Composition APIã€Axiosã€D3.js
- **ç½‘ç»œ**: Vite ä»£ç†ã€HTTP è¯·æ±‚/å“åº”
- **åç«¯**: Flask è·¯ç”±ã€ä¸šåŠ¡é€»è¾‘æœåŠ¡ã€Pandas æ•°æ®å¤„ç†
- **æ•°æ®**: Excel æ–‡ä»¶ â†’ Python å¯¹è±¡ â†’ JSON â†’ JavaScript å¯¹è±¡ â†’ D3 å¯è§†åŒ–

æ•´ä¸ªè¿‡ç¨‹æ˜¯**å¼‚æ­¥çš„**ï¼Œä½¿ç”¨ `async/await` å’Œ Promise å¤„ç†ï¼Œç¡®ä¿UIä¸ä¼šé˜»å¡ã€‚

